<h1>Intro</h1>

<div class="row">

    <p style="text-align:justify">
        Aircash a-bon platform is intended for users that wish to make payments to their Online Provider accounts (betting sites, parking services, GSM topups etc.) via paper coupons that can be bought at cash registers, i.e. points of sale of Aircash Sales Partners (kiosks, gas stations, etc.). The process of using Aircash A-bon can be observed from two perspectives: Sales Partner and Online Provider.
        <br /> <br />
        From the Sale Partner's perspective: the user comes to the cash register at a Sale Partner point of sale and asks to buy an Aircash A-bon coupon a specific value. The cash register system then contacts the Aircash backend system which then creates a coupon of the desired value. After that, the user pays for that amount, and the cash register prints out an Aircash A-bon coupon which is then given to the user.
        <br /> <br />
        From the Online Provider's perspective: the user logs in to a website or a mobile app of an Online Provider (e.g. a booking site), and chooses to deposit money via an Aircash a-bon coupon. He enters the 16-digit code from the coupon he bought, and confirms the transaction of funds to an Online Provider account. The funds are deposited to the user's online account, and the coupon gets expended and can no longer be used.
        <br /> <br />
        An example of an Aircash A-bon is shown  <a href="" ng-click="showCoupon()">here</a>
    </p>
</div>
<h1>Technical integration aspects – security and authentication</h1>
<p style="text-align:justify">
    Aircash a-bon system exposes a REST web API.
    <br /> <br />
    The API is accessed via HTTPS protocol (secured by a TLS certificate). Optionally, we can ensure access to the API through a VPN.
    <br /> <br />
    Each request towards Aircash A-bon API has to be digitally signed. This ensures non-repudiation of every request, as well as authentication.
    <br /> <br />
    Each method has a special PartnerId parameter. This is a GUID type parameter that's also generated by the Aircash team and delivered to each Sales Partner separately.
    <br /> <br />
    Only a pair of properly signed control sequences and a correct PartnerId can enable authentication to the system.
    <br /> <br />
    The partners are provided with an integration environment (staging) where it is possible to test all of the methods for integration. All the integration details of the A-bon services are described in detail in the following chapters.
</p>
<h1>Sales Partner API</h1>
<h2>Coupon creation</h2>
<p style="text-align:justify">
    The method used to let the sales partner request a new Aircash a-bon. Aircash A-bon is created using the CreateCoupon method that creates the coupon and immediately activates it.
    <br /><br />
    URL: /rest/api/CashRegister/CreateCoupon
</p>

<div class="row">
    <div class="col-md-12">
        <uib-tabset>
            <uib-tab index="request-tab-0" heading="Request" classes="nav-item">
                <table class="table table-hover">
                    <thead>
                        <tr>
                            <th>Parameters</th>
                            <th>Type</th>
                            <th>Description</th>
                            <th>Required</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>PartnerId</td>
                            <td>string</td>
                            <td>identifier of the Sales Partner</td>
                            <td>YES</td>
                        </tr>
                        <tr>
                            <td>Value</td>
                            <td>decimal</td>
                            <td>coupon value</td>
                            <td>YES</td>
                        </tr>
                        <tr>
                            <td>PointOfSaleId</td>
                            <td>string</td>
                            <td>identifier of the point of sale</td>
                            <td>YES</td>
                        </tr>
                        <tr>
                            <td>ISOCurrencySymbol</td>
                            <td>string</td>
                            <td>currency code by ISO 4217 (e.g. for EUR)</td>
                            <td>YES</td>
                        </tr>
                        <tr>
                            <td>PartnerTransactionId</td>
                            <td>string</td>
                            <td> identifier of the transaction in partner's system</td>
                            <td>YES</td>
                        </tr>
                        <tr>
                            <td>ContentType </td>
                            <td>string</td>
                            <td>
                                coupon format – „pdf“, „txt“ or „xml“. If the parameter is invalid or missing, default partner settings are used
                            </td>
                            <td>NO</td>
                        </tr>
                        <tr>
                            <td>ContentWidth </td>
                            <td>int</td>
                            <td>
                                width of the coupon (in mm for pdf, or character number for txt) Minimal value is 20. If the parameter is invalid or missing, default partner settings are used
                            </td>
                            <td>NO</td>
                        </tr>
                        <tr>
                            <td>Signature </td>
                            <td>string</td>
                            <td>
                                sequence that has been digitally signed with the provider's private signature, used for authentication
                            </td>
                            <td>YES</td>
                        </tr>
                    </tbody>
                </table>
            </uib-tab>
            <uib-tab index="request-tab-1" heading="Request example" classes="nav-item">
                <pre>
                <code>
                        {
                            "Value": 100.0,
                            "PartnerId": "8f62c8f0-7155-4c0e-8ebe-cd9357cfd1bf",
                            "PointOfSaleId": "VP001",
                            "ISOCurrencySymbol": "EUR",
                            "PartnerTransactionId": "9059ca5c-675a-48b5-b41a-e04ab5b981ae",
                            "ContentType": "pdf",
                            "ContentWidth": 80,
                            "Signature": "123...abc"
                        }
                    </code>
                </pre>
            </uib-tab>

            <uib-tab index="request-tab-2" heading="Try it out" classes="nav-item">
                <div class="row">
                    <div class="col-md-4">
                        <form action="/" method="POST">
                            <fieldset>
                                <div class="mb-3">
                                    <label class="form-label">Value</label>
                                    <input ng-model="createCouponModel.value" class="form-control" type="number" placeholder="Enter value" ng-disabled="createServiceBusy">
                                </div>
                                <div class="mb-3">
                                    <label class="form-label" for="exampleInputPassword1">PointOfSaleId</label>
                                    <input ng-model="createCouponModel.pointOfSaleId" class="form-control" type="text" placeholder="Enter PointOfSaleId" ng-disabled="createServiceBusy">
                                </div>
                                <button ng-click="createCoupon()" class="btn btn-primary w-100px me-5px" ng-disabled="createServiceBusy">Create <i ng-if="createServiceBusy" class="fa fa-cog fa-spin"></i></button>
                            </fieldset>
                        </form>
                    </div>
                    <div class="col-md-4" ng-if="createServiceResponse">
                        Request ({{requestDateTimeUTC}})
<pre>
<code>
{{serviceRequest}}
</code>
</pre>
                        Sequence: {{sequence}}<br />
                    </div>
                    <div class="col-md-4" ng-if="createServiceResponse">
                        Response ({{responseDateTimeUTC}})
<pre>
<code>
{{serviceResponse}}
</code>
</pre>
                    </div>
                </div>
            </uib-tab>
        </uib-tabset>
    </div>
</div>


<p>
    Where the Signature parameter is created by signing the following sequence:<br />
    <i>ContentType=pdf&ContentWidth=80&ISOCurrencySymbol=EUR&PartnerId=8f62c8f0-7155-4c0e-8ebe-cd9357cfd1bf&PartnerTransactionId=9059ca5c-675a-48b5-b41a-e04ab5b981ae&PointOfSaleId=VP001&Value=100</i>
</p>


<div class="row">
    <div class="col-md-7">
        <uib-tabset>
            <uib-tab index="response-tab-0" heading="200 OK Response" classes="nav-item">
                <table class="table table-hover">
                    <thead>
                        <tr>
                            <th>Parameters</th>
                            <th>Type</th>
                            <th>Description</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>SerialNumber</td>
                            <td>string</td>
                            <td>coupon serial number</td>
                        </tr>
                        <tr>
                            <td>CouponCode</td>
                            <td>string</td>
                            <td>16-digit coupon code</td>
                        </tr>
                        <tr>
                            <td>Value</td>
                            <td>decimal</td>
                            <td>coupon value</td>
                        </tr>
                        <tr>
                            <td>ISOCurrencySymbol</td>
                            <td>string</td>
                            <td>currency code by ISO 4217 (e.g. EUR)</td>
                        </tr>
                        <tr>
                            <td>Content</td>
                            <td>string</td>
                            <td>
                                base64 content in the format which was requested
                            </td>
                        </tr>
                        <tr>
                            <td>PartnerTransactionId</td>
                            <td>string</td>
                            <td>
                                identifier of the transaction in partner's system
                            </td>
                    </tbody>
                </table>
            </uib-tab>
            <uib-tab index="response-tab-1" heading="200 OK Response example" classes="nav-item">
                <pre>
                <code>
                            {
                                "serialNumber": "5722230340416087",
                                "couponCode": "3542893940565049",
                                "value": 100.0,
                                "isoCurrencySymbol": "EUR",
                                "content": "abc...123",
                                "partnerTransactionId": "0b376282-1a6f-4c1a-a7a1-36153086d760"
                            }
                    </code>
                </pre>
            </uib-tab>
            <uib-tab index="response-tab-2" heading="400 Error response" classes="nav-item">
                <table class="table table-hover table-consendent">
                    <thead>
                        <tr>
                            <th>Code</th>
                            <th>Message</th>
                            <th>Additional data</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>1</td>
                            <td>Invalid PartnerId</td>
                            <td>-</td>
                        </tr>
                        <tr>
                            <td>2</td>
                            <td>Invalid Signature</td>
                            <td>-</td>
                        </tr>
                        <tr>
                            <td>3</td>
                            <td>Invalid CouponValue</td>
                            <td>-</td>
                        </tr>
                        <tr>
                            <td>5</td>
                            <td>Invalid CurrencySymbol</td>
                            <td>-</td>
                        </tr>
                        <tr>
                            <td>6</td>
                            <td>Coupon exists for the given PartnerTransactionId</td>
                            <td>
                                serialNumber<br />
                                value<br />
                                isoCurrencySymbol<br />
                                partnerTransactionId<br />

                            </td>
                        </tr>
                        <tr>
                            <td>8</td>
                            <td>Daily limit exceeded</td>
                            <td>-</td>
                    </tbody>
                </table>
            </uib-tab>
            <uib-tab index="response-tab-3" heading="400 Error response example" classes="nav-item">
                <pre>
                <code>
                        {
                            "code": 6,
                            "message": "Coupon exists for the given PartnerTransactionId",
                            "additionalData": {
                                "serialNumber": "8023200631484066",
                                "value": 100.00,
                                "isoCurrencySymbol": "EUR",
                                "partnerTransactionId": "9059ca5c-675a-48b5-b41a-e04ab5b981ae"
                                }
                        }

                        </code>
                </pre>
            </uib-tab>
        </uib-tabset>
    </div>
</div>



<h2>Coupon cancellation</h2>

<p>URL: /rest/api/CashRegister/CancelCoupon</p>
<p style="text-align:justify">
    This method is called on the cash register in case you need to cancel the coupon (cashier's mistake, the print failed, unpaid purchase etc.). This method is intended for on-premise cancellation, and can be called in a limited time interval after issuing the coupon. (e.g. 5 minutes).
    <br /> <br />
    Besides cancelling the coupon via CancelCoupon request, partner’s support will be able to cancel coupons via the BS portal that the Aircash will give credentials for. BS portal cancellation will not have a time interval expiry.
    <br /> <br />
    Authentication is done by checking the digital signature (Signature).
</p>


<div class="row">
    <div class="col-md-12">
        <uib-tabset>
            <uib-tab index="request1-tab-0" heading="Request" classes="nav-item">
                <table class="table table-hover">
                    <thead>
                        <tr>
                            <th>Parameters</th>
                            <th>Type</th>
                            <th>Description</th>
                            <th>Required</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>PartnerId</td>
                            <td>string</td>
                            <td>identifier of the Sales Partner</td>
                            <td>YES</td>
                        </tr>
                        <tr>
                            <td>SerialNumber</td>
                            <td>string</td>
                            <td>
                                coupon serial number, while calling this method it is required to either set the SerialNumber or PartnerTransactionId
                            </td>
                            <td>YES, optional</td>
                        </tr>
                        <tr>
                            <td>PartnerTransactionId</td>
                            <td>string</td>
                            <td>
                                identifier of the transaction in partner's system, while calling this method it is required to either set the SerialNumber or PartnerTransactionId
                            </td>
                            <td>YES, optional</td>
                        </tr>
                        <tr>
                            <td>PointOfSaleId</td>
                            <td>string</td>
                            <td>identifier of the point of sale</td>
                            <td>YES</td>
                        </tr>
                        <tr>
                            <td>Signature </td>
                            <td>string</td>
                            <td>
                                A sequence that has been digitally signed with the provider's private signature, used for authentication
                            </td>
                            <td>YES</td>
                        </tr>
                    </tbody>
                </table>
            </uib-tab>
            <uib-tab index="request1-tab-1" heading="Request example" classes="nav-item">
                <pre>
                <code>
                            {
                            "SerialNumber": "5722230340416087",
                            "PartnerTransactionId": null,
                            "PartnerId": "8f62c8f0-7155-4c0e-8ebe-cd9357cfd1bf",
                            "PointOfSaleId": "VP001",
                            "Signature": "abc...123"
                            }
                        </code>
                </pre>
            </uib-tab>
            <uib-tab index="request1-tab-2" heading="Try it out" classes="nav-item">
                <div class="row">
                    <div class="col-md-4">
                        <form action="/" method="POST">
                            <fieldset>
                                <div class="mb-3">
                                    <label class="form-label">Serial Number</label>
                                    <input ng-model="cancelCouponModel.cancelSerialNumber" class="form-control" type="text" placeholder="Enter SerialNumber" ng-disabled="cancelServiceBusy">
                                </div>
                                <div class="mb-3">
                                    <label class="form-label" for="exampleInputPassword1">PointOfSaleId</label>
                                    <input ng-model="cancelCouponModel.cancelPointOfSaleId" class="form-control" type="text" placeholder="Enter PointOfSaleId" ng-disabled="cancelServiceBusy">
                                </div>
                                <button ng-click="cancelCoupon()" class="btn btn-primary w-100px me-5px" ng-disabled="cancelServiceBusy">Cancel coupon <i ng-if="cancelServiceBusy" class="fa fa-cog fa-spin"></i></button>
                            </fieldset>
                        </form>
                    </div>
                    <div class="col-md-4" ng-if="cancelServiceResponse">
                        Request ({{cancelRequestDateTimeUTC}})
<pre>
<code>
{{cancelServiceRequest}}
</code>
</pre>
                        Sequence: {{cancelSequence}}<br />
                    </div>
                    <div class="col-md-4" ng-if="cancelServiceResponse">
                        Response ({{cancelResponseDateTimeUTC}})<br />
{{cancelResponse}}
                    </div>
                </div>
            </uib-tab>
        </uib-tabset>
    </div>
</div>

{{cancelRequestDateTimeUTC}}

<p>
    Where the Signature parameter is created by signing the following sequence:<br />
    <i>
        PartnerId=8f62c8f0-7155-4c0e-8ebe-cd9357cfd1bf&PartnerTransactionId=&PointOfSaleId=VP001&Serial
        Number=5722230340416087
    </i>
</p>

<p>
    In case of successful cancellation, a HTTP 200 OK response message will be returned with an empty body.
</p>

<div class="row">
    <div class="col-md-7">
        <uib-tabset active="active">
            <uib-tab index="response1-tab-0" heading="400 Error response" classes="nav-item">
                <table class="table table-hover table-consendent">
                    <thead>
                        <tr>
                            <th>Code</th>
                            <th>Message</th>
                            <th>Additional data</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>1</td>
                            <td>Invalid PartnerId</td>
                            <td>-</td>
                        </tr>
                        <tr>
                            <td>2</td>
                            <td>Invalid Signature</td>
                            <td>-</td>
                        </tr>
                        <tr>
                            <td>3</td>
                            <td>Invalid PointOfSaleId</td>
                            <td>-</td>
                        </tr>
                        <tr>
                            <td>4</td>
                            <td>Invalid coupon serial number or partner transaction id</td>
                            <td>-</td>
                        </tr>
                        <tr>
                            <td>5</td>
                            <td>PartnerIds do not match</td>
                            <td>-</td>
                        </tr>
                        <tr>
                            <td>6</td>
                            <td>Point of sales Ids do not match</td>
                            <td>-</td>
                        </tr>
                        <tr>
                            <td>7</td>
                            <td>Coupon has been already canceled</td>
                            <td>-</td>
                        </tr>
                        <tr>
                            <td>8</td>
                            <td>Coupon has been already used</td>
                            <td>-</td>
                        </tr>
                        <tr>
                            <td>9</td>
                            <td>Coupon has already expired</td>
                            <td>-</td>
                        </tr>
                        <tr>
                            <td>10</td>
                            <td>Coupon cannot be cancelled (timeout expired)</td>
                            <td>-</td>
                        </tr>
                        <tr>
                            <td>11</td>
                            <td>Request failed</td>
                            <td>-</td>
                        </tr>
                    </tbody>
                </table>
            </uib-tab>
            <uib-tab index="response1-tab-1" heading="400 Error response example" classes="nav-item">
                <pre>
                <code>
                            {
                            "code": 7,
                            "message": "Coupon has been already cancelled",
                            "additionalData": null
                            }
                        </code>
                    </pre>
            </uib-tab>
        </uib-tabset>
    </div>
</div>

<h1>Edge cases</h1>
<p style="text-align:justify">
    This chapter will describe possible edge cases that can happen while calling the API, and how to do error recovery. Edge cases include power outage on the cash register, temporary Internet unavailability, or temporary a-bon service unavailability.
</p>
<h2>CreateCoupon method – invalid or no response</h2>
<p style="text-align:justify">
    In the case of an unsuccessful CreateCoupon call, the following error recovery methods should be
    applied.
</p>
<ol>
    <li>
        Retry policy<br /> Possible when a partner sends an internal transaction identifier (PartnerTransactionId). If the method is called again with the same parameters (mandatory same PartnerTransactionId), and if it was not previously recorded on the a-bon system, it will return the created coupon. If the coupon has been previously created and recorded on the a-bon system, the return value will be error 6: "Coupon is for the given PartnerTransactionId". For security reasons, coupon content is only sent in the first response. Therefore, in order to recover from the error, first the CancelCoupon method with the same PartnerTransactionId has to be called. After successfully invoking the CancelCoupon method, it is possible to call CreateCoupon again with the same parameters (and the same PartnerTransactionId can be used).
    </li>
    <li>
        If a Partner does not send the PartnerTransactionId, it is not possible to recover from the error. In this case, it is necessary to call the method again with the same parameters. If the transaction was successful, coupon dana will be recorded on the a-bon system. When a repeated call is made, a new coupon will be created in the system. Coupons created in the a-bon system and not delivered to the Partner will be canceled in the periodic adjustment process.
    </li>
</ol>

<h2>
    CreateCoupon method – response received
</h2>

<p style="text-align:justify">
    Partner takes over the responsibility of delivering the actual coupon paper to the buyer. When a coupon was successfully received from CreateCoupon method, but not delivered to the buyer (e.g. lack of paper in the printer), there are two scenarios possible.
</p>

<ol>
    <li>
        The Partner calls the CancelCoupon method with the serial number of the undelivered coupon (or with the PartnerTransactionId, if it was initially assigned). The coupon is then canceled in the a-bon system and is not included in the reports (it is not subjected to periodic adjustment.) Partner then recalls the CreateCoupon method and creates a new coupon.
    </li>
    <li>
        The partner can cache the coupon in memory until the conditions to deliver the coupon are met (e.g. the paper in the printer was replaced)
    </li>
</ol>

<h2>CancelCoupon method – invalid response</h2>
<p style="text-align:justify">
    The method supports repeated calls. The method can be called again with the same parameters in the case of an invalid response. In the event that the coupon was canceled by a previous call (whose response was not received), the return value contains the message 7: "Coupon has been already canceled".
</p>






<!-- #modal-dialog -->
<div class="modal fade" id="couponModal">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title">A-bon example</h4>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-hidden="true"></button>
            </div>
            <div class="modal-body" align="center">
                <img src="../../images/abon.png" alt="A-bon">
            </div>
            <div class="modal-footer">
                <a href="javascript:;" class="btn btn-white" data-dismiss="modal">Close</a>
            </div>
        </div>
    </div>
</div>


